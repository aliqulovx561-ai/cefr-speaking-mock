<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Speaking Practice App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .telegram-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #0088cc;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .telegram-link:hover {
            background: #0077b5;
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .welcome-card {
            grid-column: 1 / -1;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(52, 152, 219, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .sets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .set-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .set-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #3498db;
        }

        .set-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .set-card p {
            color: #7f8c8d;
            font-size: 14px;
        }

        .test-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        .test-container.active {
            display: block;
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .timer {
            font-size: 24px;
            font-weight: bold;
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            min-width: 100px;
            text-align: center;
        }

        .question-box {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            font-size: 20px;
            line-height: 1.6;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .recording-indicator {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: rgba(231, 76, 60, 0.2);
            border-radius: 10px;
            display: none;
        }

        .recording-indicator.active {
            display: block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .btn-record {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-record:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .btn-record.recording {
            background: #2ecc71;
        }

        .btn-record.recording:hover {
            background: #27ae60;
        }

        .btn-next {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-next:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        .completion-screen {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .completion-screen.active {
            display: block;
        }

        .completion-screen h2 {
            color: #2ecc71;
            margin-bottom: 20px;
            font-size: 32px;
        }

        .completion-screen p {
            margin-bottom: 30px;
            font-size: 18px;
            opacity: 0.9;
        }

        .voice-visualizer {
            height: 100px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 4px;
            margin: 30px 0;
        }

        .voice-bar {
            width: 10px;
            background: white;
            border-radius: 3px;
            transition: height 0.1s;
        }

        .error-message {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé§ IELTS Speaking Practice</h1>
            <p>Practice your speaking skills with mock tests and get feedback</p>
            <a href="https://t.me/IELTS_AGE" target="_blank" class="telegram-link">
                üìö Join IELTS_AGE on Telegram
            </a>
        </div>

        <div class="main-content">
            <div class="card welcome-card">
                <h2>Welcome to Speaking Practice</h2>
                <p>Enter your details to get started</p>
                
                <div class="form-group">
                    <label for="firstName">First Name</label>
                    <input type="text" id="firstName" placeholder="Enter your first name">
                </div>
                
                <div class="form-group">
                    <label for="surname">Surname</label>
                    <input type="text" id="surname" placeholder="Enter your surname">
                </div>
                
                <div class="form-group">
                    <label for="group">Group Name</label>
                    <input type="text" id="group" placeholder="Enter your group/class name">
                </div>
                
                <button class="btn" onclick="startPractice()">Start Practice</button>
            </div>

            <div class="card" id="setsContainer" style="display: none;">
                <h2>Select a Speaking Set</h2>
                <div class="sets-grid" id="setsGrid">
                    <!-- Sets will be loaded here -->
                </div>
            </div>

            <div class="card" id="testDetails" style="display: none;">
                <h2>Test Details</h2>
                <div id="testInfo"></div>
                <button class="btn" onclick="startTest()" style="margin-top: 20px;">Start Test</button>
                <button class="btn" onclick="goBackToSets()" style="margin-top: 10px; background: #95a5a6;">Back to Sets</button>
            </div>
        </div>

        <div class="error-message" id="errorMessage"></div>
    </div>

    <!-- Test Interface -->
    <div class="test-container" id="testContainer">
        <div class="test-header">
            <div id="testProgress">Part 1 - Question 1/3</div>
            <div class="timer" id="timer">2:00</div>
        </div>

        <div class="question-box" id="questionBox">
            <!-- Question will appear here -->
        </div>

        <div class="recording-indicator" id="recordingIndicator">
            ‚óè RECORDING
        </div>

        <div class="voice-visualizer" id="voiceVisualizer">
            <!-- Voice bars will be generated here -->
        </div>

        <div class="controls">
            <button class="btn-record" id="recordButton" onclick="toggleRecording()">
                Start Recording
            </button>
            <button class="btn-next" id="nextButton" onclick="nextQuestion()" disabled>
                Next Question
            </button>
        </div>

        <div class="completion-screen" id="completionScreen">
            <h2>‚úÖ Test Completed!</h2>
            <p>Your recording has been saved and sent for evaluation.</p>
            <p id="uploadStatus">Uploading to Telegram...</p>
            <button class="btn" onclick="downloadRecording()" id="downloadBtn" style="display: none;">
                Download Recording
            </button>
            <button class="btn" onclick="restartTest()" style="margin-top: 10px; background: #95a5a6;">
                Start New Test
            </button>
        </div>
    </div>

    <script>
        // Application State
        const state = {
            student: {
                firstName: '',
                surname: '',
                group: ''
            },
            currentSet: null,
            currentPart: 0,
            currentQuestion: 0,
            isRecording: false,
            mediaRecorder: null,
            audioChunks: [],
            audioBlob: null,
            timer: null,
            timeLeft: 0,
            stream: null,
            analyser: null,
            audioContext: null,
            testData: null
        };

        // Sample test data
        const speakingSets = [
            {
                id: 1,
                name: "Speaking Set 1",
                active: true,
                part1: [
                    "What kind of weather do you like most?",
                    "Do you prefer reading books or watching movies?",
                    "How often do you go shopping?"
                ],
                part2: {
                    cue: "Describe a time when you helped someone.",
                    prompts: [
                        "Who did you help?",
                        "How did you help them?",
                        "How did you feel afterwards?"
                    ]
                },
                part3: [
                    "Do you think helping others is important in society?",
                    "How can schools teach children to help others?",
                    "What are some benefits of volunteering?"
                ]
            },
            {
                id: 2,
                name: "Speaking Set 2",
                active: true,
                part1: [
                    "What's your favorite type of music?",
                    "Do you enjoy cooking?",
                    "How do you usually spend your weekends?"
                ],
                part2: {
                    cue: "Talk about an interesting place you have visited.",
                    prompts: [
                        "Where is this place?",
                        "What did you do there?",
                        "Why was it interesting?"
                    ]
                },
                part3: [
                    "Why do people like to travel?",
                    "What are the benefits of tourism?",
                    "How can tourism affect local cultures?"
                ]
            }
        ];

        // Initialize voice visualizer
        function initVoiceVisualizer() {
            const visualizer = document.getElementById('voiceVisualizer');
            visualizer.innerHTML = '';
            for (let i = 0; i < 30; i++) {
                const bar = document.createElement('div');
                bar.className = 'voice-bar';
                bar.style.height = '20px';
                visualizer.appendChild(bar);
            }
        }

        // Update voice visualizer
        function updateVoiceVisualizer() {
            if (!state.analyser || !state.isRecording) return;
            
            const bufferLength = state.analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            state.analyser.getByteFrequencyData(dataArray);
            
            const bars = document.querySelectorAll('.voice-bar');
            bars.forEach((bar, i) => {
                const index = Math.floor(i * bufferLength / bars.length);
                const value = dataArray[index];
                const height = Math.max(10, (value / 255) * 100);
                bar.style.height = height + 'px';
            });
            
            if (state.isRecording) {
                requestAnimationFrame(updateVoiceVisualizer);
            }
        }

        // Start practice
        function startPractice() {
            const firstName = document.getElementById('firstName').value.trim();
            const surname = document.getElementById('surname').value.trim();
            const group = document.getElementById('group').value.trim();
            
            if (!firstName || !surname || !group) {
                showError('Please fill in all fields');
                return;
            }
            
            state.student = { firstName, surname, group };
            showSets();
        }

        // Show available sets
        function showSets() {
            document.querySelector('.welcome-card').style.display = 'none';
            document.getElementById('setsContainer').style.display = 'block';
            
            const setsGrid = document.getElementById('setsGrid');
            setsGrid.innerHTML = '';
            
            speakingSets.forEach(set => {
                if (set.active) {
                    const setCard = document.createElement('div');
                    setCard.className = 'set-card';
                    setCard.innerHTML = `
                        <h3>${set.name}</h3>
                        <p>Click to start this speaking set</p>
                    `;
                    setCard.onclick = () => selectSet(set);
                    setsGrid.appendChild(setCard);
                }
            });
        }

        // Select a set
        function selectSet(set) {
            state.currentSet = set;
            document.getElementById('setsContainer').style.display = 'none';
            document.getElementById('testDetails').style.display = 'block';
            
            document.getElementById('testInfo').innerHTML = `
                <p><strong>Set:</strong> ${set.name}</p>
                <p><strong>Student:</strong> ${state.student.firstName} ${state.student.surname}</p>
                <p><strong>Group:</strong> ${state.student.group}</p>
                <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                <hr>
                <h3>Test Structure:</h3>
                <p>‚Ä¢ Part 1: ${set.part1.length} questions</p>
                <p>‚Ä¢ Part 2: Cue card discussion</p>
                <p>‚Ä¢ Part 3: ${set.part3.length} follow-up questions</p>
            `;
        }

        // Go back to sets
        function goBackToSets() {
            document.getElementById('testDetails').style.display = 'none';
            document.getElementById('setsContainer').style.display = 'block';
            state.currentSet = null;
        }

        // Start test
        async function startTest() {
            try {
                // Request microphone access
                state.stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                });
                
                // Initialize audio context
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = state.audioContext.createMediaStreamSource(state.stream);
                state.analyser = state.audioContext.createAnalyser();
                state.analyser.fftSize = 256;
                source.connect(state.analyser);
                
                // Initialize MediaRecorder
                state.mediaRecorder = new MediaRecorder(state.stream);
                state.audioChunks = [];
                
                state.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        state.audioChunks.push(event.data);
                    }
                };
                
                state.mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(state.audioChunks, { 
                        type: 'audio/webm;codecs=opus' 
                    });
                    state.audioBlob = audioBlob;
                };
                
                // Show test interface
                document.querySelector('.container').style.display = 'none';
                document.getElementById('testContainer').classList.add('active');
                document.getElementById('completionScreen').classList.remove('active');
                
                // Initialize test
                state.currentPart = 1;
                state.currentQuestion = 0;
                state.testData = {
                    part1: [...state.currentSet.part1],
                    part2: { ...state.currentSet.part2 },
                    part3: [...state.currentSet.part3]
                };
                
                initVoiceVisualizer();
                showQuestion();
                startTimer(120); // 2 minutes for part 1
                
            } catch (error) {
                showError('Microphone access is required. Please allow microphone access and try again.');
                console.error('Microphone error:', error);
            }
        }

        // Show current question
        function showQuestion() {
            const questionBox = document.getElementById('questionBox');
            let question = '';
            let progress = '';
            
            if (state.currentPart === 1) {
                question = state.testData.part1[state.currentQuestion];
                progress = `Part 1 - Question ${state.currentQuestion + 1}/${state.testData.part1.length}`;
            } else if (state.currentPart === 2) {
                question = `<strong>${state.testData.part2.cue}</strong><br><br>`;
                state.testData.part2.prompts.forEach((prompt, i) => {
                    question += `‚Ä¢ ${prompt}<br>`;
                });
                progress = 'Part 2 - Cue Card';
            } else if (state.currentPart === 3) {
                question = state.testData.part3[state.currentQuestion];
                progress = `Part 3 - Question ${state.currentQuestion + 1}/${state.testData.part3.length}`;
            }
            
            document.getElementById('testProgress').textContent = progress;
            questionBox.innerHTML = question;
            
            // Reset recording state
            state.isRecording = false;
            document.getElementById('recordingIndicator').classList.remove('active');
            document.getElementById('recordButton').textContent = 'Start Recording';
            document.getElementById('recordButton').classList.remove('recording');
            document.getElementById('nextButton').disabled = true;
        }

        // Start timer
        function startTimer(seconds) {
            clearInterval(state.timer);
            state.timeLeft = seconds;
            
            state.timer = setInterval(() => {
                state.timeLeft--;
                updateTimerDisplay();
                
                if (state.timeLeft <= 0) {
                    clearInterval(state.timer);
                    if (state.isRecording) {
                        toggleRecording(); // Stop recording
                    }
                    nextQuestion();
                }
            }, 1000);
            
            updateTimerDisplay();
        }

        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(state.timeLeft / 60);
            const seconds = state.timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Toggle recording
        function toggleRecording() {
            if (!state.isRecording) {
                // Start recording
                state.audioChunks = [];
                state.mediaRecorder.start(1000); // Collect data every second
                state.isRecording = true;
                
                document.getElementById('recordingIndicator').classList.add('active');
                document.getElementById('recordButton').textContent = 'Stop Recording';
                document.getElementById('recordButton').classList.add('recording');
                document.getElementById('nextButton').disabled = true;
                
                updateVoiceVisualizer();
            } else {
                // Stop recording
                state.mediaRecorder.stop();
                state.isRecording = false;
                
                document.getElementById('recordingIndicator').classList.remove('active');
                document.getElementById('recordButton').textContent = 'Start Recording';
                document.getElementById('recordButton').classList.remove('recording');
                document.getElementById('nextButton').disabled = false;
            }
        }

        // Next question
        function nextQuestion() {
            if (state.isRecording) {
                toggleRecording();
                return;
            }
            
            if (state.currentPart === 1) {
                state.currentQuestion++;
                if (state.currentQuestion >= state.testData.part1.length) {
                    state.currentPart = 2;
                    state.currentQuestion = 0;
                    startTimer(180); // 3 minutes for part 2
                } else {
                    startTimer(45); // 45 seconds per question
                }
            } else if (state.currentPart === 2) {
                state.currentPart = 3;
                state.currentQuestion = 0;
                startTimer(90); // 1.5 minutes per question in part 3
            } else if (state.currentPart === 3) {
                state.currentQuestion++;
                if (state.currentQuestion >= state.testData.part3.length) {
                    finishTest();
                    return;
                } else {
                    startTimer(90);
                }
            }
            
            showQuestion();
        }

        // Finish test
        async function finishTest() {
            clearInterval(state.timer);
            
            // Stop recording if active
            if (state.isRecording) {
                toggleRecording();
            }
            
            // Wait for final audio blob
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Stop all audio tracks
            if (state.stream) {
                state.stream.getTracks().forEach(track => track.stop());
            }
            
            if (state.audioContext) {
                await state.audioContext.close();
            }
            
            // Show completion screen
            document.getElementById('completionScreen').classList.add('active');
            
            // Send to Telegram
            await sendToTelegram();
        }

        // Send recording to Telegram
        async function sendToTelegram() {
            const uploadStatus = document.getElementById('uploadStatus');
            
            if (!state.audioBlob) {
                uploadStatus.textContent = 'No recording available to upload';
                document.getElementById('downloadBtn').style.display = 'block';
                return;
            }
            
            uploadStatus.innerHTML = '<span class="loading"></span> Uploading to Telegram...';
            
            try {
                // Convert blob to base64
                const base64Audio = await blobToBase64(state.audioBlob);
                
                const message = `Test completed successfully.`;
                
                const response = await fetch('/api/telegram', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        audio: base64Audio,
                        fileName: `${state.student.firstName}_${state.student.surname}_Set${state.currentSet.id}.mp3`,
                        studentInfo: {
                            firstName: state.student.firstName,
                            surname: state.student.surname,
                            group: state.student.group,
                            date: new Date().toLocaleDateString(),
                            time: new Date().toLocaleTimeString()
                        },
                        setInfo: {
                            name: state.currentSet.name,
                            id: state.currentSet.id
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    uploadStatus.textContent = '‚úÖ Recording sent to Telegram successfully!';
                } else {
                    uploadStatus.textContent = '‚ö†Ô∏è Recording saved but upload failed: ' + (result.error || 'Unknown error');
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                uploadStatus.textContent = '‚ö†Ô∏è Failed to upload: ' + error.message;
            }
            
            document.getElementById('downloadBtn').style.display = 'block';
        }

        // Download recording
        function downloadRecording() {
            if (!state.audioBlob) {
                showError('No recording available');
                return;
            }
            
            const fileName = `${state.student.firstName}_${state.student.surname}_${state.currentSet.name}_${new Date().toISOString().split('T')[0]}.webm`;
            const url = URL.createObjectURL(state.audioBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Restart test
        function restartTest() {
            // Reset state
            state.currentSet = null;
            state.currentPart = 0;
            state.currentQuestion = 0;
            state.isRecording = false;
            state.mediaRecorder = null;
            state.audioChunks = [];
            state.audioBlob = null;
            state.stream = null;
            state.analyser = null;
            state.audioContext = null;
            state.testData = null;
            
            clearInterval(state.timer);
            
            // Reset UI
            document.getElementById('testContainer').classList.remove('active');
            document.querySelector('.container').style.display = 'block';
            document.querySelector('.welcome-card').style.display = 'none';
            document.getElementById('setsContainer').style.display = 'block';
            document.getElementById('testDetails').style.display = 'none';
            document.getElementById('completionScreen').classList.remove('active');
            
            showSets();
        }

        // Helper function to convert blob to base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    // Remove data URL prefix
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // Show error message
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('active');
            setTimeout(() => errorEl.classList.remove('active'), 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('IELTS Speaking App initialized');
            initVoiceVisualizer();
        });

        // Make functions available globally
        window.startPractice = startPractice;
        window.startTest = startTest;
        window.goBackToSets = goBackToSets;
        window.toggleRecording = toggleRecording;
        window.nextQuestion = nextQuestion;
        window.downloadRecording = downloadRecording;
        window.restartTest = restartTest;
    </script>
</body>
</html>
